<budgt-ui-page>
  <h1>Expense Tracking</h1>
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        {{ currentMonth | monthYear }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form
        class="expense-form"
        [formGroup]="expenseForm"
        (ngSubmit)="onSubmit()"
      >
        <mat-form-field>
          <mat-label>Amount (SEK)</mat-label>
          <input
            formControlName="amount"
            matInput
            inputmode="numeric"
            [inputMask]="amountMask"
          />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Category</mat-label>
          <mat-select formControlName="category">
            <mat-option
              *ngFor="let category of categories$ | async"
              [value]="category['name']"
              >{{ category['name'] }}</mat-option
            >
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Choose a date</mat-label>
          <input formControlName="date" matInput [matDatepicker]="picker" />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker touchUi #picker></mat-datepicker>
        </mat-form-field>

        <button mat-flat-button color="primary" class="submit-btn">Add</button>
      </form>

      @if (expenses$ | async; as expenses) {
        @if (expenses.length) {
          <table
            mat-table
            [dataSource]="dataSource"
            matSort
            matSortActive="date"
            matSortDirection="desc"
            class="expense-table"
          >
            <ng-container matColumnDef="date">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Sort by date"
              >
                Date
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.date }}
              </td>
            </ng-container>

            <ng-container matColumnDef="amount">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Sort by amount"
              >
                Amount
              </th>
              <td mat-cell *matCellDef="let element">
                {{ element.amount | amount }}
              </td>
            </ng-container>

            <ng-container matColumnDef="category">
              <th
                mat-header-cell
                *matHeaderCellDef
                mat-sort-header
                sortActionDescription="Sort by category"
              >
                Category
              </th>
              <td mat-cell *matCellDef="let element">
                <div class="category-cell">
                  <div>{{ element.category }}</div>
                  <button mat-icon-button (click)="onRemove(element.id)">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        } @else {
          <p class="no-expenses">No expenses for this month</p>
        }
      } @else {
        <div class="spinner-container">
          <mat-spinner diameter="50" class="spinner"></mat-spinner>
        </div>
      }
    </mat-card-content>
    <mat-card-footer>
      <div class="footer-container">
        <button mat-icon-button (click)="onChangeMonth(false)">
          <mat-icon>arrow_back_ios</mat-icon>
        </button>
        <button mat-icon-button (click)="onChangeMonth(true)">
          <mat-icon>arrow_forward_ios</mat-icon>
        </button>
      </div>
    </mat-card-footer>
  </mat-card>
</budgt-ui-page>
